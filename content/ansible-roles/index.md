---
author: jtprogru
categories: Basics
comments: false
# cover:
#     image: "<image path/url>"
#     alt: "<alt text>"
#     caption: "<text>"
#     relative: false
date: 2022-08-21T12:09:58+03:00
description: ""
disableShare: false
draft: true
hidemeta: false
showToc: false
tags:
  - ansible
  - basics
  - ansiblerole
title: '[Basics] Ansible Roles'
type: post
---

Привет, `%username%`!  Я уже не первый раз вспоминаю про такой классный инструмент, как [Ansible](https://docs.ansible.com/ansible/latest/index.html). Давай в этот раз посмотрим на такую штуку как Ansible Roles – роли в Ansible.

## Что такое Ansible?

О том, что такое Ansible написано уже множество статей в сети. Про [основные понятия ansible](https://jtprog.ru/ansible-basic/#основные-понятия-ansible) я уже писал – там все просто. Но на всякий случай быстренько пробежимся по основным моментам.

Ansible – это система управления конфигурациями. Если перевести на простейший язык, то ansible – это такая штука, которая позволяет воспроизводить конфигурацию на множестве схожих систем.

Давай разберем на примере. Представь, что у тебя один твой любимый серверочек и ты его долго настраивал: устанавливал пакеты руками, правил конфиги, настраивал красивенький `motd`, чтоб при логине в систему тебе показывалось всякое разное и полезное. И вот в один прекрасный (или не очень) день, по не зависящей от тебя причине твой "огородик" сдох, а вместе с ним и его бэкапы (свежа еще история в памяти о [пожаре в ДЦ](https://habr.com/ru/news/t/546264/)). В обычной ситуации ты просто найдешь другой сервер и будешь снова все настраивать руками. Будешь делать все в точности как и было, но немного другое – некоторые вещи становятся не актуальными, а некоторые ты просто забываешь со временем. По итогу ты получаешь хоть и похожий, но немного другой “огородик”.

В альтернативной ситуации, с точно таким же пожаром, но используя Ansible, ты развернешь “идентичный огородик” – даже “сорняки” будут на тех же местах. И, что не менее важно, ты это сделаешь в разы быстрее, чем руками.

## Состав роли

И так, давай посмотрим из чего должна состоять хорошая роль. Для того чтобы посмотреть на "дефолтную роль", достаточно выполнить инициализацию роли с помощью утилиты `ansible-galaxy`:

```bash
ansible-galaxy init jtprogru.packages
- Role jtprogru.packages was created successfully
```

В данном примере создается роль под названием `jtprogru.packages` – директория с именем `jtprogru.packages` будет создана в текущей директории откуда запускалась `ansible-galaxy`. Вот так выглядит структура файлов и директорий:

```bash
tree -a jtprogru.packages
jtprogru.packages
├── defaults
├── files
├── handlers
├── meta
├── tasks
├── templates
├── tests
└── vars

8 directories, 9 files
```

Немного подробнее по некоторым пунктам:

- `defaults` – Директория с дефолтными значениями некоторых переменных;
- `files` – Тут положено складывать все файлики, которые необходимы (бинари, готовые конфиги, публичные сертификаты и ключи);
- `handlers` – Тут хранятся хендлеры, которые должны реагировать на выполнение задач;
- `meta` – Метаинформация о роли (автор, организация, etc);
- `tasks` – Тут хранятся задачи из которых состоит роль;
- `templates` – Тут хранятся шаблоны в формате Jinja2;
- `tests` – Тесты! Да, роль – это "код", а любой код должен быть покрыт тестами;
- `vars` – Общие переменные для роли, например OS-specific переменные;

Почти в каждой директории создается файл `main.yml` – это своего рода `index.html` – входная точка для роли и каждого ее компонента.

Давай рассмотрим чуть подробнее некоторые моменты.

### defaults

Тут складываются те переменные, которыми можно управлять из вне. Это значит, что в этой директории размещаются те переменные, которые очень желательно переопределять на уровне инвентаря, но значения указанные для них являются валидными и роль может отработать корректно.

### handlers

Хэндлеры - это такие же таски, но запускаются только в случае если произошли изменения и их вызвали. Простой пример: после настройки Nginx'a тебе надо бы проверить валидность нового конфига через `sudo nginx -t` и если все "ОК", то корректно применить его через `sudo nginx -s reload`. Вот для таких ситуаций и нужны хендлеры – выполнять какие-либо задачи в случае изменения конфигураций на управляемом хосте. По сути, хендлеры - это такие же задачи, а главное преимущество хендлеров в том, что они запускаются только в случае наличия изменений. Т.е. если у тебя конфиг не изменился – твой Nginx не будет перезапускаться.

### tasks

Основное место, где описываются все задачи, из которых состоит роль. Все шаги, которые ansible должен выполнить для описываются именно тут.

### templates

Шаблоны любых файлов в формате Jinja2 складываешь в этой директории и встроенный модуль `template` будет искать эти шаблоны в этой директории.

### vars

Сюда складываешь все OS-specific переменные и/или те переменные, которые не требуется показывать внешнему пользователю твоей роли.

### files

Самое простое место для хранения какого-либо файла. Например какая-то сложно-собираемая и трудно-доставаемая зависимость строго определенной версии в виде бинарника может спокойно лежать тут и не отсвечивать. Ты просто будешь копировать этот файлик туда, куда это требуется.

### meta

Nребуется использовать в том случае, когда ты собираешься распростарнять свою роль через [Ansible Galaxy](https://galaxy.ansible.com) или просто начинаешь вести управление ролями через "внутренний galaxy" (заводишь отдельный репозиторий под каждую роль и подключаешь строго определенные версии ролей в инфра-репозиторий). Считается хорошим тоном заполнять данный раздел и указывать в нем зависимости от других ролей. При установке такой роли через `ansible-galaxy install -r requirements.yaml` ее зависимость будет так же установлена без явного указания в файле `requirements.yaml`.

### test

Лично я не использую данную директорию для хранения тестов, потому что привык к отдельному инструменту тестирования ролей – [Molecule](https://molecule.readthedocs.io/en/latest/) и его тесты хранятся рядом в директории `molecule`.

## Практика

Немного о том, что и за что отвечает я тебе рассказал. Теперь я тебе расскажу свой подход к разработке ролей, как я стараюсь делать и как я не делаю, а главное поясню "почему именно так, а не иначе".

### Создание роли

Если речь идет о не публичной роли – той, которую я не буду публиковать в Ansible Galaxy – то тут все просто:

```bash
cd roles
mkdir jtprogru.my_new_role/{defaults,handlers,tasks,templates}
vim .
git init/add/commit/push
```

Если речь идет о публичной роли – той, которую я буду публиковать в Ansible Galaxy – то тут по канону используется утилита `ansible-galaxy`:

```bash
ansible-galaxy init jtprogru.my_new_role
cd jtprogru.my_new_role
vim .
git init/add/commit/push
```

Я же пользуюсь альтернативным вариантом - инициализация директории с ролью через Molecule (сразу генерируется шаблон для тестирования роли с использованием Molecule):

```bash
molecule init role jtprogru.my_new_role --driver-name docker
cd jtprogru.my_new_role
vim .
git init/add/commit/push
```

У меня была попытка сделать шаблон роли – [sample-role](https://github.com/jtprogru/sample-role). Чтоб можно было форкнуть/скачать архив/скопипастить и иметь уже готовый скелет с тестами в виде Molecule и прочим, а в идеале собрать из нее нормальный шаблон для [Cookiecutter](https://cookiecutter.readthedocs.io/en/stable/) – если будет желание, кидай PR.

## Итоги

Посмотреть на мои роли можно на моей страничке [Github](https://github.com/jtprogru?tab=repositories&q=ansible-role&type=&language=&sort=).

---
Если у тебя есть вопросы, комментарии и/или замечания – заходи в [чат](https://ttttt.me/jtprogru_chat), а так же подписывайся на [канал](https://ttttt.me/jtprogru_channel).
