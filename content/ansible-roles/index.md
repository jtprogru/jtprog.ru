---
author: jtprogru
categories: Basics
comments: false
# cover:
#     image: "<image path/url>"
#     alt: "<alt text>"
#     caption: "<text>"
#     relative: false
date: 2022-08-21T12:09:58+03:00
description: ""
disableShare: false
draft: true
hidemeta: false
showToc: false
tags:
  - ansible
  - basics
  - ansiblerole
title: '[Basics] Ansible Roles'
type: post
---

Привет, `%username%`!  Я уже не первый раз вспоминаю про такой классный инструмент, как [Ansible](https://docs.ansible.com/ansible/latest/index.html). Давай в этот раз посмотрим на такую штуку как Ansible Roles – роли в Ansible.

## Что такое Ansible?

О том, что такое Ansible написано уже множество статей в сети. Про [основные понятия ansible](https://jtprog.ru/ansible-basic/#основные-понятия-ansible) я уже писал – там все просто. Но на всякий случай быстренько пробежимся по основным моментам.

Ansible – это система управления конфигурациями. Если перевести на простейший язык, то ansible – это такая штука, которая позволяет воспроизводить конфигурацию на множестве схожих систем.

Давай разберем на примере. Представь, что у тебя один твой любимый серверочек и ты его долго настраивал: устанавливал пакеты руками, правил конфиги, настраивал красивенький `motd`, чтоб при логине в систему тебе показывалось всякое разное и полезное. И вот в один прекрасный (или не очень) день, по не зависящей от тебя причине твой "огородик" сдох, а вместе с ним и его бэкапы (свежа еще история в памяти о [пожаре в ДЦ](https://habr.com/ru/news/t/546264/)). В обычной ситуации ты просто найдешь другой сервер и будешь снова все настраивать руками. Будешь делать все в точности как и было, но немного другое – некоторые вещи становятся не актуальными, а некоторые ты просто забываешь со временем. По итогу ты получаешь хоть и похожий, но немного другой “огородик”.

В альтернативной ситуации, с точно таким же пожаром, но используя Ansible, ты развернешь “идентичный огородик” – даже “сорняки” будут на тех же местах. И, что не менее важно, ты это сделаешь в разы быстрее, чем руками.

## Состав роли

И так, давай посмотрим из чего должна состоять хорошая роль. Для того чтобы посмотреть на "дефолтную роль", достаточно выполнить инициализацию роли с помощью утилиты `ansible-galaxy`:

```bash
ansible-galaxy init jtprogru.packages
- Role jtprogru.packages was created successfully
```

В данном примере создается роль под названием `jtprogru.packages` – директория с именем `jtprogru.packages` будет создана в текущей директории откуда запускалась `ansible-galaxy`. Вот так выглядит структура файлов и директорий:

```bash
tree -a jtprogru.packages
jtprogru.packages
├── defaults
├── files
├── handlers
├── meta
├── tasks
├── templates
├── tests
└── vars

8 directories, 9 files
```

Немного подробнее по некоторым пунктам:

- `defaults` – Директория с дефолтными значениями некоторых переменных;
- `files` – Тут положено складывать все файлики, которые необходимы (бинари, готовые конфиги, публичные сертификаты и ключи);
- `handlers` – Тут хранятся хендлеры, которые должны реагировать на выполнение задач;
- `meta` – Метаинформация о роли (автор, организация, etc);
- `tasks` – Тут хранятся задачи из которых состоит роль;
- `templates` – Тут хранятся шаблоны в формате Jinja2;
- `tests` – Тесты! Да, роль – это "код", а любой код должен быть покрыт тестами;
- `vars` – Общие переменные для роли, например OS-specific переменные;

Почти в каждой директории создается файл `main.yml` – это своего рода `index.html` – входная точка для роли и каждого ее компонента.

Давай рассмотрим чуть подробнее некоторые моменты.

### defaults

Тут складываются те переменные, которыми можно управлять из вне. Это значит, что в этой директории размещаются те переменные, которые очень желательно переопределять на уровне инвентаря, но значения указанные для них являются валидными и роль может отработать корректно.

### handlers

Хэндлеры - это такие же таски, но запускаются только в случае если произошли изменения и их вызвали. Простой пример: после настройки Nginx'a тебе надо бы проверить валидность нового конфига через `sudo nginx -t` и если все "ОК", то корректно применить его через `sudo nginx -s reload`. Вот для таких ситуаций и нужны хендлеры – выполнять какие-либо задачи в случае изменения конфигураций на управляемом хосте. По сути, хендлеры - это такие же задачи, а главное преимущество хендлеров в том, что они запускаются только в случае наличия изменений. Т.е. если у тебя конфиг не изменился – твой Nginx не будет перезапускаться.

### tasks

Основное место, где описываются все задачи, из которых состоит роль. Все шаги, которые ansible должен выполнить для описываются именно тут.

### templates

Шаблоны любых файлов в формате Jinja2 складываешь в этой директории и встроенный модуль `template` будет искать эти шаблоны в этой директории.

### vars

Сюда складываешь все OS-specific переменные и/или те переменные, которые не требуется показывать внешнему пользователю твоей роли.

### files

Самое простое место для хранения какого-либо файла. Например какая-то сложно-собираемая и трудно-доставаемая зависимость строго определенной версии в виде бинарника может спокойно лежать тут и не отсвечивать. Ты просто будешь копировать этот файлик туда, куда это требуется.

### meta

Nребуется использовать в том случае, когда ты собираешься распростарнять свою роль через [Ansible Galaxy](https://galaxy.ansible.com) или просто начинаешь вести управление ролями через "внутренний galaxy" (заводишь отдельный репозиторий под каждую роль и подключаешь строго определенные версии ролей в инфра-репозиторий). Считается хорошим тоном заполнять данный раздел и указывать в нем зависимости от других ролей. При установке такой роли через `ansible-galaxy install -r requirements.yaml` ее зависимость будет так же установлена без явного указания в файле `requirements.yaml`.

### test

Лично я не использую данную директорию для хранения тестов, потому что привык к отдельному инструменту тестирования ролей – [Molecule](https://molecule.readthedocs.io/en/latest/) и его тесты хранятся рядом в директории `molecule`.

## Практика

Немного о том, что и за что отвечает я тебе рассказал. Теперь я тебе расскажу свой подход к разработке ролей, как я стараюсь делать и как я не делаю, а главное поясню "почему именно так, а не иначе".

### Инициализация роли

Если речь идет о не публичной роли (которую я не буду публиковать в Ansible Galaxy или хоть как-то показывать кому-то кроме себя), то тут все просто:

```bash
cd roles
mkdir jtprogru.my_new_role/{defaults,handlers,tasks,templates}
vim .
git init/add/commit/push
```

Если речь идет о публичной роли (которую я буду публиковать в Ansible Galaxy), то тут можно воспользоваться утилитой `ansible-galaxy`:

```bash
ansible-galaxy init my_new_role
cd my_new_role
vim .
git init/add/commit/push
```

Я же пользуюсь альтернативным вариантом - инициализация роли через Molecule (сразу генерируется шаблон для тестирования роли с использованием Molecule):

```bash
molecule init role jtprogru.my_new_role --driver-name docker
cd my_new_role
vim .
git init/add/commit/push
```

У меня была попытка сделать шаблон роли – [sample-role](https://github.com/jtprogru/sample-role). Чтоб можно было форкнуть/скачать архив/скопипастить и иметь уже готовый скелет с тестами в виде Molecule и прочим, а в идеале собрать из нее нормальный шаблон для [Cookiecutter](https://cookiecutter.readthedocs.io/en/stable/) – если будет желание, кидай PR.

### Написание кода

В чем писать - вообще до фонаря, главное чтобы твой редактор умел корректно работать с отступами. Я в зависимости от настроения использую VIM, VS Code, GoLand/PyCharm - все с кучей разных плагинов.

На что стоит обращать внимание при написании кода роли:

#### именование тасок

Простой пример:

```yaml
- name: my_new_role | install pkg
  ansible.builtin.apt:
    name: "{{ base_soft_list }}"
    update_cache: false
```

Каждый раз, когда имя задачи начинается с имени роли я мысленно говорю себе спасибо за то, что я смогу отличить эту задачу в общем выхлопе плейбука. Ведь задача с именем `- name: install pkg` может быть где угодно, так ведь? А вот с конкретным имененем `- name: my_new_role | install pkg` будет явно только в моей роли.

#### хендлеры

На конференции [DevOpsConf 2022](https://devopsconf.io/moscow/2022/schedule) я совершенно случайно узнал про "топики". Топики это такая штука, благодаря которой тебе в своих задачах не надо перечислять нотифаи. Вот так ты делаешь обычно:

```yaml
- name: "jtprogru.install_atop | generate default config for atop"
  ansible.builin.template:
    src: "atop.j2"
    dest: "{{ atop_config_path }}"
    owner: root
    group: root
    mode: 0644
  notify: 
    - restart atop
    - restart atopacct
```

А теперь ты можешь просто написать один нотифай, а ansible сам все поймет и сделает правильно. Например вот так будет выглядеть задача:

```yaml
# tasks/main.yaml
- name: "jtprogru.install_atop | generate default config for atop"
  ansible.builin.template:
    src: "atop.j2"
    dest: "{{ atop_config_path }}"
    owner: root
    group: root
    mode: 0644
  notify: atop listner

# handlers/main.yaml
- name: restart atop
  ansible.builtin.service:
    name: atop.service
    state: restarted
  listen: atop listner

- name: restart atopacct
  ansible.builtin.service:
    name: atopacct.service
    state: restarted
  listen: atop listner
```

И оба этих сервиса будут перезапущены. Более того, ты в своих ролях можешь слать нотифай в топики других своих ролей.

#### линтеры

Обязательно используй линтеры! Их не так много, но их достаточно:

- `ansible-lint`
- `yamllint`

Каждый из них настраиваешь и прогоняешь перед коммитом. В идеале добавить их в [pre-commit-hooks](https://pre-commit.com/) и тогда система тебе просто не даст закоммитить в репозиторий кривой код.

### Тестирование

Про тестирование можно говорить бесконечно и это в целом отдельная тема для холиваров, но стоит упомянуть про некоторые вещи. Например, уже упомянутая мною [molecule](https://molecule.readthedocs.io/en/latest/). Однако, в работе с molecule на текущий момент есть огромный нюанс. Текущая версия поддерживает исключительно два типа драйверов (того, на базе чего будут запускаться ваши роли), это `Delegated` и `Docker`.

Как именно инициализировать роль с тестами от molecule я уже показал выше, но повторюсь – вот такой командой:

```bash
molecule init role jtprogru.my_new_role --driver-name docker
```

После чего, можно смело идти в файл `molecule/default/molecule.yml` и добавлять различные варианты Docker images для различных платформ. Например вот так:

```yaml
# molecule/default/molecule.yml
---
dependency:
  name: galaxy

driver:
  name: docker

platforms:
  - name: instance-cs8
    image: quay.io/centos/centos:stream8
    pre_build_image: true
  - name: instance-ub22
    image: ubuntu:22.04
    pre_build_image: true

provisioner:
  name: ansible

verifier:
  name: ansible
```

В тестовом инвентаре у тебя будет два хоста:

- `instance-cs8` - будет запущен из образа `quay.io/centos/centos:stream8` с docker registry `quay.io`;
- `instance-ub22` - будет запущен из образа `ubuntu:22.04` с docker registry `hub.docker.com`;

Важно лишь помнить, что далеко не все варианты можно протестировать в Docker’e. Например, если у тебя в роли выполняется управление сервисами [systemd](https://jtprog.ru/sys-init/) или настройка параметров ядра через [sysctl](https://jtprog.ru/sysctl-hl/), то вариант тестирования в Docker тебе совсем не подойдет. Можно посмотреть в сторону [Vagrant’a](https://www.vagrantup.com) (как именно обойти санкции использую VPN – инструкций предостаточно в сети, но если сложно, то заходи в [чат](https://ttttt.me/jtprogru_chat) и спросить) и через синхронизацию директорий (vagrant будет просто монтировать указанную директорию в нужный каталог внутри гостевой системы) катать внутри нужной гостевой ОС.

В остальном, все что касается тестирования – это в большинстве случаев краеугольный камень. Ты либо тестируешь свои роли, либо не тестируешь. Выбор как обычно за тобой.

### Где и как хранить

Начну с того, что есть два варианта хранения всех ролей (про наркоманские упоминать не буду – не та ситуация). Первый вариант – публичный – отправлять все свои роли в [Ansible Galaxy](https://galaxy.ansible.com/jtprogru). Этот вариант стоит использовать только в том случае, если написанные роли можно публиковать в интернет (тебе не стыдно их показать и компания не возбраняет это). Второй вариант – приватный – хранить свои роли у себя на приватном git-сервере. Это самый частый вариант хранения, потому что “низя показывать нашу интеллектуальную собственность” (и еще тысяча вариантов фразы “нам стыдно”).

Если публичное Ansible Galaxy не подходит по различным причинам, то просто не парься и создавай отдельный репозиторий под каждую роль. А в инфраструктурном репозитории просто подключаешь все через специальный файлик `requirements.yaml` – пример:

```yaml
roles:
  # Установка роли из конкретной ветки из Github
  - name: jtprogru.install_atop
    src: https://github.com/jtprogru/ansible-role-install-atop
    version: origin/master

	# Установка роли по конкретному тегу из Github
  - name: jtprogru.install_atop
    src: https://github.com/jtprogru/ansible-role-install-atop
	  version: 2022.9.0
	
	# Установка роли ко конкретному коммиту из Github
  - name: jtprogru.install_atop
    src: https://github.com/jtprogru/ansible-role-install-atop
	  version: 752b9cf7ed13261736b257317e41d1bc03261d61

  # Установка роли из Ansible Galaxy
  - name: jtprogru.install_atop
```

Вообще, я категорически рекомендую использовать данный файлик для фиксации всех зависимостей – внутренних/внешних ролей и коллекций. Логика тут простейшая: ты можешь переписывать свою роль сколько угодно и совершенно не бояться чего-то сломать в инфраструктуре. Этот же подход позволит коллегам из смежных команд спокойно пользоваться твоими ролями, а когда что-то новое привносишь в свою роль – оповещаешь коллег об этом.

## Вопросы и ответы

Перед написанием данной статьи я кинул клич в своем канале и [просил накидать разных странных вопросов](https://ttttt.me/jtprogru_channel/4132) на тему ролей. А изначальная идея статьи вообще была предложена [одним Senior Golang Developer](https://t.me/cursor_legiona) у которого я учусь писать на Golang.

Теперь попробую внятно ответить только на часть вопросов, потому что некоторые из пропущенных вопросов тянут на отдельную статью (а то и целую серию).

**Вопрос**: Что лучше – универсальная роль на несколько ОСей или под каждую ОСь своя?
**Ответ**: Зависит от задачи которую ты хочешь решить. Если ты хочешь без головной боли управлять “одним и тем же конфигом” в разных ОСях (RHEL/Debian/BSD), то логичнее сделать универсальную роль. Универсальная роль тебе будет гарантированно выполнять одно и то же вне зависимости от целевой ОСи.

## Итоги

Посмотреть на мои роли можно на моей страничке [Github](https://github.com/jtprogru?tab=repositories&q=ansible-role&type=&language=&sort=).

---
Если у тебя есть вопросы, комментарии и/или замечания – заходи в [чат](https://ttttt.me/jtprogru_chat), а так же подписывайся на [канал](https://ttttt.me/jtprogru_channel).
